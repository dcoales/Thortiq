# Section 4.2.5 Formatting Menu Plan

1. Audit the existing collaborative editor setup (`packages/client-core`, `packages/client-react`) to understand current ProseMirror schema, selection handling, and formatting commands while confirming compliance with AGENTS.md rules #3, #6, and #20-25 (single editor instance, Yjs-driven undo, no DOM surgery while typing).
2. Define the data model for node-level flags (`headerLevel`, `isParagraph`, `isNumbered`) and inline mark attributes (`textColor`, `backgroundColor`) in the shared Yjs-backed schema, ensuring updates always flow through `withTransaction` helpers and store edge-local state when required (AGENTS rule #5).
3. Extend shared selectors and view models so outline rows expose the new formatting flags without leaking Yjs structures to React; prefer pure helpers in `packages/client-core` to keep adapters thin (rules #8, #13).
4. Implement ProseMirror commands for H1-H5 that map headers to block node attributes or wrapping nodes, applying styles that match spec sizing (H5 = body size, H1 largest) and ensuring toggles integrate with the unified UndoManager.
5. Implement commands for paragraph, numbered list, and bullet modes that coordinate node metadata with UI rendering: hide bullets for paragraph rows (except collapsed parents), clear conflicting flags per spec, and compute sequential numbering that resumes from the closest numbered sibling above the transaction target.
6. Add inline mark toggles for bold, italic, underline, and clear formatting using ProseMirror mark APIs, guaranteeing that clear formatting removes all relevant marks/attrs from the selection while remaining transaction-safe.
7. Design a color palette model with eight default 80% opacity swatches, plus persistence for user edits via the appropriate preferences store (check existing user settings Yjs map); implement helper utilities for palette CRUD and guard them with undo-grouped transactions.
8. Build a floating selection menu component (`packages/client-react`) that listens to editor selection changes, renders inside a portal anchored to the current selection rectangle, and avoids interfering with TanStack virtualization or the row DOM tree (rules #4, #7, #23).
9. Wire menu actions to the ProseMirror commands, including keyboard shortcuts and focus management so the menu is fully keyboard-accessible (rule #34) and dismisses gracefully on selection collapse or editor blur.
10. Implement the text/background color pickers, including palette edit mode with plus/save/cancel flow, color picker integration, and confirmation dialog when canceling after changes; ensure modal dialogs reuse existing platform adapter patterns and remain responsive offline (rules #14, #28).
11. Update outline row rendering so paragraph and numbered flags drive bullet visibility/number rendering without breaking mirrors or virtualization; store numbering display data on edge instances to respect rule #5.
12. Add comprehensive tests: shared logic unit tests in `packages/client-core`, interaction tests for the React editor that perform real selection/command dispatch flows (AGENTS rule #19), and regression coverage for undo/redo and numbering continuity.
13. Document the new formatting system by updating developer docs (e.g., `docs/thortiq_spec.md` if needed) and cross-linking relevant architecture notes, ensuring future work references this plan and any new adapter interfaces.

## Step 1 Audit Notes
- **Rule #20 (single instance)**: `apps/web/src/outline/ActiveNodeEditor.tsx:792` keeps a lone `createCollaborativeEditor` instance per pane, reusing it across node switches via `setNode` and reparenting with `setContainer`.
- **Rules #21-22 (visual parity)**: the editor injects shared typography styles and inherits row metrics (`packages/editor-prosemirror/src/index.ts:51`, `packages/editor-prosemirror/src/index.ts:392`), while `OutlineRowView` hides static text when the live editor is attached to prevent duplicate rendering (`packages/client-react/src/outline/components/OutlineRowView.tsx:366`).
- **Rule #3 (transactions)**: shared mutations flow through `withTransaction` (`packages/client-core/src/doc/transactions.ts:57`), and editor-side mutations wrap ProseMirror dispatch in `outline.doc.transact(...)` when direct registry updates are needed (`packages/editor-prosemirror/src/index.ts:552`).
- **Rule #6 / #24 (unified undo)**: `createSyncContext` provisions a single `UndoManager` shared with the editor (`packages/sync-core/src/index.ts:41`), and the editor adds the Yjs sync origin plus the `yUndoPlugin` so structural and text edits land in the same history (`packages/editor-prosemirror/src/index.ts:262`, `packages/editor-prosemirror/src/index.ts:756`).
- **Rule #23 (virtualization compatibility)**: Active editor DOM is reparented to a detached host during row recycling so TanStack Virtual keeps stable measurements (`apps/web/src/outline/ActiveNodeEditor.tsx:863`), and the collaborative view exposes `setContainer` to support that handoff (`packages/editor-prosemirror/src/index.ts:300`).
- **Rule #25 (deterministic sequencing)**: selection recovery still uses a bounded `requestAnimationFrame` retry loop for freshly mounted editors (`apps/web/src/outline/ActiveNodeEditor.tsx:924`); keep this behaviour in mind when adding new formatting UI to avoid introducing additional frame-sensitive dependencies.
- **Current schema gap**: the ProseMirror schema sticks with `prosemirror-schema-basic` plus tag/wiki marks (`packages/editor-prosemirror/src/schema.ts:1`), so header nodes, paragraph flags, numbering metadata, and color attrs remain unimplemented—future steps must extend both schema and rendered outline data.

## Step 2 Schema Plan
- **Node metadata extensions** (`packages/client-core/src/types.ts`, `packages/client-core/src/doc/nodes.ts`): add optional `headingLevel: 1 | 2 | 3 | 4 | 5` and `layout: "standard" | "paragraph" | "numbered"` fields to `NodeMetadata`, initialise them when creating nodes, and expose helpers (`setNodeHeadingLevel`, `setNodeLayout`) that wrap `withTransaction()` so callers never mutate Yjs maps directly (AGENTS #3, #12). When `layout` switches to `"paragraph"` or `"numbered"` the helper clears conflicting modes per spec (paragraph clears numbered, numbered clears paragraph, `"standard"` clears both).
- **Edge-local numbering context** (`packages/client-core/src/doc/edges.ts`, `packages/client-core/src/selectors.ts`): keep list membership on the node via `layout`, but project a computed `listOrdinal` per edge when building rows so mirrors inherit numbering relative to their parent while preserving edge-local state (AGENTS #5). The ordinal derives from sibling ordering and continues sequences when the previous sibling is also `"numbered"`.
- **Snapshot & row model updates** (`packages/client-core/src/doc/snapshots.ts`, `packages/client-core/src/selectors.ts`, `packages/client-react/src/outline/useOutlineRows.ts`): extend snapshot nodes to surface `headingLevel` and `layout`, and add the derived `listOrdinal` to `OutlineRow`. This keeps React adapters free of Yjs mutations while making formatting flags available for rendering and keyboard handlers.
- **Search/type classification** (`packages/client-core/src/search/index.ts`): update the `type` classifier so nodes report `"heading"`, `"paragraph"`, or `"numbered"` based on the new metadata, preserving backward compatibility by defaulting to `"outline"` when `layout` is `"standard"` and `headingLevel` is undefined.
- **Inline color marks** (`packages/editor-prosemirror/src/schema.ts`, `packages/client-core/src/doc/nodes.ts`): introduce `textColor` and `backgroundColor` marks with a stable `color` attribute (hex/RGBA string). Because `extractInlineContent` already decodes arbitrary mark attrs, no Yjs schema changes are required—simply ensure the new mark names/attrs round-trip through the XML fragment and snapshot pipeline.
- **Documentation & invariants** (`docs/architecture/outline-data-model.md`): record the new metadata keys, clarify that heading/layout live on nodes (shared across mirrors), and that list ordinals are computed per edge during snapshotting to honour AGENTS #5.

## Step 3 Selector Plan
- **Shared formatting model** (`packages/client-core/src/types.ts`): add an immutable `NodeFormatting` shape exposing `headingLevel`, `layout`, and optional `listOrdinal`; export it so selectors and adapters share one contract.
- **Snapshot enrichment** (`packages/client-core/src/doc/snapshots.ts`): project `NodeFormatting` onto each `NodeSnapshot` during snapshot creation, deriving defaults when metadata is missing. Keep computation linear and side-effect free to satisfy AGENTS #7.
- **Row derivation helpers** (`packages/client-core/src/selectors.ts`): factor a pure `deriveRowFormatting` utility that consumes the snapshot node plus sibling context to calculate paragraph/numbered flags and the sequential `listOrdinal`. Reuse it in both `buildPaneRows` and `buildSearchPaneRows` so numbered lists behave identically in normal and search views.
- **Sibling ordinal tracking** (`packages/client-core/src/selectors.ts`): introduce a lightweight per-parent tracker (e.g., `Map<NodeId, number>`) that increments only when consecutive siblings share `layout === "numbered"`; mirrors should reuse their parent edge id to keep numbering edge-local per AGENTS #5.
- **React row adapter** (`packages/client-react/src/outline/useOutlineRows.ts`): extend `OutlineRow` to include a `formatting: NodeFormatting` field; avoid leaking the underlying metadata map by copying the derived struct only.
- **Selector tests** (`packages/client-core/src/paneSelectors.test.ts`, `packages/client-core/src/selectors.test.ts`): add coverage for heading propagation, paragraph flag behaviour, and numbering continuation across siblings/mirrors to ensure future changes respect the contract before UI work begins.

## Step 4 Heading Commands
- Added shared heading utilities in `packages/editor-prosemirror/src/formattingCommands.ts` that expose `createSetHeadingCommand`, `createToggleHeadingCommand`, and `getActiveHeadingLevel`, capping levels to H1–H5 and using `setBlockType` so changes run inside the existing Yjs transaction/undo flow (AGENTS #3, #6, #24).
- `createCollaborativeEditor` now surfaces `setHeadingLevel`, `toggleHeadingLevel`, and `getActiveHeadingLevel`, reusing the new commands and keeping focus on the live editor after execution (`packages/editor-prosemirror/src/index.ts:520`).
- Injected heading typography rules into the shared stylesheet so edit-mode headings match spec (bold, increasing size while preserving layout stability) without extra DOM mutations (`packages/editor-prosemirror/src/index.ts:68`).
- Added integration tests covering heading toggles and undo behaviour to protect the unified history contract (`packages/editor-prosemirror/src/index.test.ts:218`).

## Step 5 Paragraph & Numbered Commands
- Extended `NodeMetadata` with `layout`/`headingLevel` and normalised storage helpers so every node snapshot carries an explicit layout (`packages/client-core/src/types.ts`, `packages/client-core/src/doc/nodes.ts:171`).
- Introduced `setNodeLayout` to batch-update layouts inside a single transaction while skipping untouched nodes (`packages/client-core/src/doc/nodes.ts:132`).
- Added outline-level commands for paragraph, numbered, and standard bullet states that dedupe edge selections, update shared metadata, and return affected edges (`packages/outline-commands/src/index.ts:249`).
- Covered layout commands with unit tests ensuring metadata toggles and deduplication behave as expected (`packages/outline-commands/src/index.test.ts:143`).

## Step 6 Inline Formatting
- Added `underline` mark support to the shared editor schema so underline styling round-trips through Yjs snapshots (`packages/editor-prosemirror/src/schema.ts:12`).
- Implemented reusable inline formatting commands (bold/italic/underline toggles and clear-formatting) with stored-mark cleanup to keep future typing unstyled (`packages/editor-prosemirror/src/formattingCommands.ts:38`).
- Exposed the new commands via `createCollaborativeEditor`, including keyboard bindings for `Mod-u`, so UI layers can invoke them without direct ProseMirror access (`packages/editor-prosemirror/src/index.ts:508`).
- Added integration tests that verify mark toggles and clear-formatting behaviour, including stored-mark reset logic (`packages/editor-prosemirror/src/index.test.ts:270`).
